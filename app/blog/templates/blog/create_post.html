{% extends 'base.html' %}
{% block content %}
{% load static %}

<script>
    tinymce.init({
        selector: '#editor',
        plugins: 'image link lists code',
        toolbar: 'undo redo | styles | bold italic underline | alignleft aligncenter alignright | image link | code',
        height: 400
    });

    /*evalua el DOM entero*/
    /* function runAccessibilityCheck(event) {
        event.preventDefault();

        const iframe = document.querySelector('iframe'); // el iframe de TinyMCE
        if (!iframe) {
            alert("❌ El editor no está disponible aún.");
            return;
        }

        const editorBody = iframe.contentDocument.body;

        axe.run(editorBody).then(results => {
            if (results.violations.length === 0) {
                alert("✅ ¡El contenido del editor es accesible!");
                document.getElementById('post-form').submit();
            } else {
                let errores = results.violations.map(v => `• ${v.help} (${v.id})`).join('\n');
                alert(`⚠️ Se encontraron ${results.violations.length} problemas de accesibilidad SOLO en el contenido del editor:\n\n${errores}`);
                console.warn("Violaciones encontradas:", results.violations);
            }
        }).catch(err => {
            console.error("Error al ejecutar axe-core:", err);
            alert("❌ Error al ejecutar la validación de accesibilidad.");
        });
    } */

    function runAccessibilityCheck(event) {
        event.preventDefault();

        const iframe = document.querySelector('iframe'); // el iframe de TinyMCE
        if (!iframe) {
            alert("❌ El editor no está disponible aún.");
            return;
        }

        const editorBody = iframe.contentDocument.body;

        axe.run(editorBody).then(results => {
            if (results.violations.length === 0) {
                alert("✅ ¡El contenido del editor es accesible!");
                document.getElementById('post-form').submit();
            } else {
                let errores = results.violations.map(v => `• ${v.help} (${v.id})`).join('\n');
                alert(`⚠️ Se encontraron ${results.violations.length} problemas de accesibilidad SOLO en el contenido del editor:\n\n${errores}`);
                console.warn("Violaciones encontradas:", results.violations);
                console.log("Violaciones encontradas:", results.violations);
            }
        }).catch(err => {
            console.error("Error al ejecutar axe-core:", err);
            alert("❌ Error al ejecutar la validación de accesibilidad.");
        });
    }
</script>

<h1>Crear nueva entrada</h1>
<form id="post-form" method="POST">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" onclick="runAccessibilityCheck(event)">🧪 Comprobar accesibilidad y publicar</button>
</form>

{% endblock content%}